<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>RoofSpy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>

  <link rel="manifest" href="/static/manifest.webmanifest">
  <meta name="theme-color" content="#111111">
  <link rel="apple-touch-icon" href="/static/icon-512.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{ --topPad:10px; --panelPad:10px; }

    html, body { height:100%; margin:0; padding:0; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif;
      background:#fff;
      overflow:auto;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    #top{
      position:relative;
      padding:var(--topPad) 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      border-bottom:1px solid #e5e5e5;
      flex-wrap:wrap;
      flex:0 0 auto;
    }

    #logo{
      position:absolute;
      top:8px;
      right:12px;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:800;
      pointer-events:none;
      user-select:none;
    }
    #logo img{
      width:34px; height:34px;
      border-radius:8px;
      border:1px solid #e6e6e6;
      background:#fff;
    }

    #map{
      flex:1 1 auto;
      min-height:340px;
    }

    #panel{
      padding:var(--panelPad) 12px;
      border-top:1px solid #e5e5e5;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-start;
      flex:0 0 auto;
    }

    .box{
      border:1px solid #e5e5e5;
      padding:10px;
      border-radius:12px;
      background:#fafafa;
    }
    button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      white-space:nowrap;
    }
    input,select{
      padding:10px;
      border-radius:12px;
      border:1px solid #ccc;
    }
    input[type="number"]{ width:96px; }
    pre{ margin:0; white-space:pre-wrap; font-size:13px; line-height:1.35; }
    .small{ font-size:12px; color:#444; margin-top:6px; }
    .btnrow button{ margin-right:8px; margin-top:6px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    /* Results overlay */
    #overlay{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; z-index:9999; }
    #card{ position:absolute; inset:10px; background:#fff; border-radius:14px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 10px 40px rgba(0,0,0,.35); }
    #topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-bottom:1px solid #e5e5e5; background:#fafafa; }
    #title{ font-weight:800; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    #frame{ flex:1; width:100%; border:0; }

    @media (max-width:600px){
      :root{ --topPad:8px; --panelPad:8px; }
      #map{ min-height:240px; }
      #logo{ top:6px; right:8px; }
      button,input,select{ padding:9px 10px; }
      .box{ padding:9px; }
      #card{ inset:0; border-radius:0; }
      #topbar{ padding:12px; }
    }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>

<body>
  <div id="top">
    <div id="logo"><img src="/static/icon-192.png" alt="RoofSpy">RoofSpy</div>

    <div class="box">
      <b>Florida Jurisdiction</b><br/>
      <div class="row" style="margin-top:6px;">
        <select id="jurisdiction"></select>
        <button id="btnRefreshJ">Refresh</button>
        <button id="btnDeleteJ" title="Deletes selected jurisdiction">Delete</button>
      </div>
      <div class="small">Pick the city/county permit system to scan.</div>
    </div>

    <div class="box">
      <b>Draw</b><br/>
      <button id="btnDraw">Start</button>
      <button id="btnFinish">Finish</button>
      <button id="btnClear">Clear</button>
      <div class="small">Tap points → Finish</div>
    </div>

    <div class="box">
      <b>Parcels</b><br/>
      <label>Limit:</label>
      <input id="limit" type="number" value="300" min="10" max="5000"/>
      <button id="btnFetch">Fetch</button>
      <div class="small">Uses Palm Beach ArcGIS parcels (fast).</div>
    </div>

    <div class="box">
      <b>Scan</b><br/>
      <label><input id="fastmode" type="checkbox" /> Fast</label>
      <label style="margin-left:10px;">Delay:</label>
      <input id="delay" type="number" value="1.0" min="0" step="0.1"/>
      <button id="btnStart">Start</button>
      <button id="btnStop">Stop</button>
      <div class="small">If errors spike: Delay 1.3–1.8</div>
    </div>

    <div class="box">
      <b>Add Jurisdiction</b>
      <div class="small">Admin tool.</div>
      <div class="row" style="margin-top:6px;">
        <input id="jName" placeholder="Name (e.g., City of X)" style="min-width:220px;">
        <select id="jSystem">
          <option value="energov">energov</option>
        </select>
      </div>
      <div class="row" style="margin-top:6px;">
        <input id="jUrl" placeholder="Permit portal URL" style="min-width:360px;">
        <button id="btnAddJ">Add</button>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <div id="panel">
    <div class="box" style="min-width: 320px; flex: 1;">
      <b>Status</b>
      <pre id="status">Ready.</pre>
      <div id="downloads" style="margin-top:8px;"></div>
      <div class="small">Results open inside the app.</div>
    </div>
  </div>

  <div id="overlay" role="dialog" aria-modal="true">
    <div id="card">
      <div id="topbar">
        <div id="title">Results</div>
        <button id="btnClose">Close</button>
      </div>
      <iframe id="frame" title="RoofSpy Results Viewer"></iframe>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const KEY = new URLSearchParams(location.search).get("k") || "";
    const statusEl = document.getElementById("status");
    const downloadsEl = document.getElementById("downloads");
    const jurSel = document.getElementById("jurisdiction");

    function apiUrl(path){
      const u = new URL(path, location.origin);
      if(KEY) u.searchParams.set("k", KEY);
      return u.toString();
    }

    let holdUntil=0;
    function setStatus(msg, holdMs=0){
      if(holdMs) holdUntil = Date.now()+holdMs;
      statusEl.textContent = msg;
    }

    async function loadJurisdictions(){
      jurSel.innerHTML = `<option>Loading…</option>`;
      const r = await fetch(apiUrl("/api/jurisdictions"));
      const j = await r.json();
      if(!j.ok){ jurSel.innerHTML = `<option>Error</option>`; return; }
      const items = j.jurisdictions || [];
      jurSel.innerHTML = items.map(x => `<option value="${x.id}">${x.name} (${x.system})</option>`).join("");
      if(items.length === 0) jurSel.innerHTML = `<option>No jurisdictions</option>`;
    }
    document.getElementById("btnRefreshJ").onclick = loadJurisdictions;

    document.getElementById("btnAddJ").onclick = async () => {
      const name = document.getElementById("jName").value.trim();
      const system = document.getElementById("jSystem").value.trim();
      const portal_url = document.getElementById("jUrl").value.trim();
      if(!name || !system || !portal_url){ alert("Fill name/system/url"); return; }
      const r = await fetch(apiUrl("/api/jurisdictions/add"),{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ state:"FL", name, system, portal_url })
      });
      const j = await r.json();
      if(!j.ok){ alert("Add failed: " + (j.error||"")); return; }
      document.getElementById("jName").value = "";
      document.getElementById("jUrl").value = "";
      await loadJurisdictions();
      setStatus("Added jurisdiction.", 2000);
    };

    document.getElementById("btnDeleteJ").onclick = async () => {
      const id = parseInt(jurSel.value || "0", 10);
      if(!id) return alert("Select a jurisdiction first.");
      if(!confirm("Delete selected jurisdiction?")) return;
      const r = await fetch(apiUrl("/api/jurisdictions/delete"),{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ id })
      });
      const j = await r.json();
      if(!j.ok){ alert("Delete failed: " + (j.error||"")); return; }
      await loadJurisdictions();
      setStatus("Deleted jurisdiction.", 2000);
    };

    // --- Map ---
    const map = L.map("map").setView([26.7153,-80.0534],12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19, attribution:"&copy; OpenStreetMap"}).addTo(map);
    setTimeout(()=>{ try{map.invalidateSize();}catch(e){} }, 450);

    let drawing=false, points=[], tempLine=null, finalPoly=null;
    let lastPolygonLatLngs=null; // [[lat,lng],...]
    let parcels=[];

    function clearAll(){
      drawing=false; points=[]; lastPolygonLatLngs=null; parcels=[];
      downloadsEl.innerHTML="";
      if(tempLine){ map.removeLayer(tempLine); tempLine=null; }
      if(finalPoly){ map.removeLayer(finalPoly); finalPoly=null; }
      setStatus("Cleared.", 1500);
    }
    function startDrawing(){ clearAll(); drawing=true; setStatus("Drawing… tap points then Finish.", 2500); }
    function finishPolygon(){
      if(!drawing) return alert("Tap Start first");
      if(points.length<3) return alert("Need 3+ points");
      drawing=false;
      if(tempLine){ map.removeLayer(tempLine); tempLine=null; }
      finalPoly = L.polygon(points,{weight:2}).addTo(map);
      lastPolygonLatLngs = points.map(p=>[p.lat,p.lng]);
      setStatus("Polygon saved. Tap Fetch.", 2500);
    }

    map.on("click",(e)=>{
      if(!drawing) return;
      points.push(e.latlng);
      if(tempLine) map.removeLayer(tempLine);
      tempLine = L.polyline(points,{weight:2,dashArray:"6 6"}).addTo(map);
      setStatus(`Drawing… points: ${points.length}`, 1200);
    });

    async function fetchParcels(){
      if(!lastPolygonLatLngs) return alert("Draw area then Finish.");
      const limit = parseInt(document.getElementById("limit").value||"300",10);
      setStatus("Fetching parcel addresses…", 2500);

      const r = await fetch(apiUrl("/api/parcels"),{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ latlngs:lastPolygonLatLngs, limit })
      });
      const j = await r.json();
      if(!j.ok){ setStatus("Error: "+(j.error||"unknown"), 6000); return; }
      parcels = j.parcels || [];
      setStatus(`Fetched ${parcels.length} parcels. Tap Start.`, 3000);
    }

    async function startScan(){
      if(!parcels.length) return alert("Fetch parcels first.");
      const jurisdiction_id = parseInt(jurSel.value||"0",10);
      if(!jurisdiction_id) return alert("Select a jurisdiction first.");

      const delay = parseFloat(document.getElementById("delay").value||"1.0");
      const fast_mode = document.getElementById("fastmode").checked;

      setStatus("Starting scan…", 2500);
      const r = await fetch(apiUrl("/api/start"),{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ jurisdiction_id, parcels, delay, fast_mode })
      });
      const j = await r.json();
      if(!j.ok){ setStatus("Error: "+(j.error||"unknown"), 6000); }
    }

    async function stopScan(){
      await fetch(apiUrl("/api/stop"),{method:"POST"});
      setStatus("Stopping…", 1500);
    }

    // Overlay viewer
    const overlay = document.getElementById("overlay");
    const frame = document.getElementById("frame");
    const titleEl = document.getElementById("title");
    document.getElementById("btnClose").onclick = () => {
      overlay.style.display="none";
      frame.src="about:blank";
    };
    overlay.addEventListener("click",(e)=>{
      if(e.target===overlay){
        overlay.style.display="none";
        frame.src="about:blank";
      }
    });

    function openView(title, path){
      titleEl.textContent = title;
      frame.src = apiUrl(path);
      overlay.style.display="block";
    }

    function renderDownloads(){
      downloadsEl.innerHTML = `
        <div class="btnrow">
          <button id="viewAll">View ALL</button>
          <button id="viewGood">View GOOD 20+</button>
          <button id="csvAll">Download ALL (CSV)</button>
          <button id="csvGood">Download GOOD (CSV)</button>
        </div>
      `;
      document.getElementById("viewAll").onclick = () => openView("RoofSpy Results (ALL)", "/results/all");
      document.getElementById("viewGood").onclick = () => openView("RoofSpy Results (GOOD 20+)", "/results/good");
      document.getElementById("csvAll").onclick = () => window.location.href = apiUrl("/download/all");
      document.getElementById("csvGood").onclick = () => window.location.href = apiUrl("/download/good");
    }

    async function poll(){
      if(Date.now()<holdUntil) return;
      const r = await fetch(apiUrl("/api/status"));
      if(r.status===401){ setStatus("Unauthorized. Use the link with ?k=YOUR_SECRET_KEY"); return; }
      const s = await r.json();
      if(s.running){
        downloadsEl.innerHTML="";
        setStatus(`Running… ${s.done}/${s.total} | Good: ${s.good}\n${s.message||""}`);
      } else if (s.message && s.message.startsWith("Done.")) {
        setStatus(`Done. Number of good leads: ${s.good}`);
        renderDownloads();
      }
    }

    document.getElementById("btnDraw").onclick = startDrawing;
    document.getElementById("btnFinish").onclick = finishPolygon;
    document.getElementById("btnClear").onclick = clearAll;
    document.getElementById("btnFetch").onclick = fetchParcels;
    document.getElementById("btnStart").onclick = startScan;
    document.getElementById("btnStop").onclick = stopScan;

    setInterval(poll,1500);
    loadJurisdictions();
  </script>
</body>
</html>
