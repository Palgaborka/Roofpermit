<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>RoofSpy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>

  <!-- PWA -->
  <link rel="manifest" href="/static/manifest.webmanifest">
  <meta name="theme-color" content="#111111">

  <!-- iOS Home Screen icon support -->
  <link rel="apple-touch-icon" href="/static/icon-512.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif; background:#fff; }
    #top { padding: 10px 12px; display:flex; gap:10px; align-items:center; border-bottom:1px solid #e5e5e5; flex-wrap:wrap; }
    #map { height: calc(100vh - 170px); }
    #panel { padding:10px 12px; border-top:1px solid #e5e5e5; display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .box { border:1px solid #e5e5e5; padding:10px; border-radius:10px; background:#fafafa; }
    button { padding:10px 12px; border-radius:10px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    input[type="number"] { padding:10px; width:90px; border-radius:10px; border:1px solid #ccc; }
    label { user-select:none; }
    pre { margin:0; white-space:pre-wrap; font-size:13px; line-height:1.35; }
    .small { font-size:12px; color:#444; margin-top:6px; }
    a { color:#0a66c2; text-decoration:none; }
    .btnrow button { margin-right:8px; }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>

<body>
  <div id="top">
    <div class="box">
      <b>Draw</b><br/>
      <button id="btnDraw">Start</button>
      <button id="btnFinish">Finish</button>
      <button id="btnClear">Clear</button>
      <div class="small">Tap points → Finish</div>
    </div>

    <div class="box">
      <b>Parcels</b><br/>
      <label>Limit:</label>
      <input id="limit" type="number" value="80" min="10" max="2000"/>
      <button id="btnFetch">Fetch</button>
    </div>

    <div class="box">
      <b>Scan</b><br/>
      <label><input id="fastmode" type="checkbox" /> Fast</label>
      <label style="margin-left:10px;">Delay:</label>
      <input id="delay" type="number" value="1.2" min="0" step="0.1"/>
      <button id="btnStart">Start</button>
      <button id="btnStop">Stop</button>
      <div class="small">If errors spike: Delay 1.3–1.8</div>
    </div>
  </div>

  <div id="map"></div>

  <div id="panel">
    <div class="box" style="min-width: 320px; flex: 1;">
      <b>Status</b>
      <pre id="status">Ready.</pre>
      <div id="downloads" style="margin-top:8px;"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Register service worker (optional)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/sw.js').catch(()=>{});
    }

    const params = new URLSearchParams(location.search);
    const KEY = params.get("k") || "";

    function apiUrl(path) {
      const u = new URL(path, location.origin);
      if (KEY) u.searchParams.set("k", KEY);
      return u.toString();
    }

    const map = L.map('map').setView([26.7153, -80.0534], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let drawing=false, points=[], tempLine=null, finalPoly=null;
    let lastPolygonLatLngs=null, addresses=[];
    let holdUntil=0;

    const statusEl = document.getElementById('status');
    const downloadsEl = document.getElementById('downloads');

    function setStatus(msg, holdMs=0){
      if (holdMs>0) holdUntil=Date.now()+holdMs;
      statusEl.textContent = msg;
    }

    function clearAll(){
      drawing=false; points=[]; lastPolygonLatLngs=null; addresses=[];
      downloadsEl.innerHTML='';
      if(tempLine){ map.removeLayer(tempLine); tempLine=null; }
      if(finalPoly){ map.removeLayer(finalPoly); finalPoly=null; }
      setStatus("Cleared.", 1500);
    }

    function startDrawing(){ clearAll(); drawing=true; setStatus("Drawing… tap points then Finish.", 3000); }
    function finishPolygon(){
      if(!drawing){ alert("Tap Start first."); return; }
      if(points.length < 3){ alert("Need 3+ points."); return; }
      drawing=false;
      if(tempLine){ map.removeLayer(tempLine); tempLine=null; }
      finalPoly = L.polygon(points, {weight:2}).addTo(map);
      lastPolygonLatLngs = points.map(p => [p.lat, p.lng]);
      setStatus("Polygon saved. Tap Fetch.", 3000);
    }

    map.on('click', (e)=>{
      if(!drawing) return;
      points.push(e.latlng);
      if(tempLine) map.removeLayer(tempLine);
      tempLine = L.polyline(points, {weight:2, dashArray:"6 6"}).addTo(map);
      setStatus(`Drawing… points: ${points.length}`, 1500);
    });

    async function fetchParcels(){
      if(!lastPolygonLatLngs){ alert("Draw + Finish first."); return; }
      const limit = parseInt(document.getElementById('limit').value || "80", 10);
      setStatus("Fetching parcel addresses…", 4000);

      const r = await fetch(apiUrl("/api/parcels"), {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ latlngs: lastPolygonLatLngs, limit })
      });

      const data = await r.json();
      if(!data.ok){ setStatus("Error: " + (data.error || "unknown"), 6000); return; }
      addresses = data.addresses || [];
      setStatus(`Fetched ${addresses.length} addresses. Tap Start.`, 4000);
    }

    async function startScan(){
      if(!addresses.length){ alert("Fetch parcels first."); return; }
      const delay = parseFloat(document.getElementById('delay').value || "1.2");
      const fast_mode = document.getElementById('fastmode').checked;
      setStatus("Starting scan…", 3000);

      const r = await fetch(apiUrl("/api/start"), {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ addresses, delay, fast_mode })
      });

      const data = await r.json();
      if(!data.ok){ setStatus("Error: " + (data.error || "unknown"), 6000); }
    }

    async function stopScan(){
      await fetch(apiUrl("/api/stop"), { method:"POST" });
    }

    // iPhone/PWA-safe download: fetch -> blob -> share (iOS) or save (desktop)
    async function downloadCsv(path, filename) {
      try {
        setStatus("Preparing download…", 2000);

        const resp = await fetch(apiUrl(path), { method: "GET" });
        if (!resp.ok) {
          const txt = await resp.text();
          alert("Download error:\n" + txt);
          return;
        }

        const blob = await resp.blob();

        // Best UX on iPhone Home Screen apps: Share sheet
        if (navigator.share && blob.size < 20 * 1024 * 1024) {
          const file = new File([blob], filename, { type: "text/csv" });
          await navigator.share({ files: [file], title: "RoofSpy CSV" });
          return;
        }

        // Fallback: standard browser download
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert("Download failed: " + e);
      }
    }

    function renderDownloadButtons() {
      downloadsEl.innerHTML = `
        <div class="btnrow">
          <button id="dlAll">Download ALL CSV</button>
          <button id="dlGood">Download GOOD (20+)</button>
        </div>
        <div class="small">On iPhone: you may get a Share prompt (Files / Save to device).</div>
      `;

      document.getElementById("dlAll").onclick = () => downloadCsv("/download/all", "leads_all.csv");
      document.getElementById("dlGood").onclick = () => downloadCsv("/download/good", "leads_good_20plus.csv");
    }

    async function poll(){
      if(Date.now() < holdUntil) return;

      const r = await fetch(apiUrl("/api/status"));
      if (r.status === 401) {
        setStatus("Unauthorized. Open the app using the link with ?k=YOUR_SECRET_KEY");
        return;
      }
      const s = await r.json();

      if(s.running){
        downloadsEl.innerHTML = ""; // hide downloads while running
        setStatus(`Running… ${s.done}/${s.total} | Good(20+): ${s.good}\nStarted: ${s.started_at}\n${s.message}`);
      } else if (s.message && s.message.startsWith("Done.")) {
        setStatus(`Not running.\n${s.message}`);
        renderDownloadButtons();
      } else {
        // idle
        if (!downloadsEl.innerHTML) {
          downloadsEl.innerHTML = `<div class="small">Run a scan to enable downloads.</div>`;
        }
      }
    }

    document.getElementById('btnDraw').addEventListener('click', startDrawing);
    document.getElementById('btnFinish').addEventListener('click', finishPolygon);
    document.getElementById('btnClear').addEventListener('click', clearAll);
    document.getElementById('btnFetch').addEventListener('click', fetchParcels);
    document.getElementById('btnStart').addEventListener('click', startScan);
    document.getElementById('btnStop').addEventListener('click', stopScan);

    setInterval(poll, 1500);
  </script>
</body>
</html>
