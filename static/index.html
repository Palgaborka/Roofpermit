<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>RoofSpy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>

  <link rel="manifest" href="/static/manifest.webmanifest">
  <meta name="theme-color" content="#111111">

  <link rel="apple-touch-icon" href="/static/icon-512.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --mapH: 58vh;
      --topPad: 10px;
      --panelPad: 10px;
    }

    body {
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      background:#fff;
      overflow:hidden;
    }

    #top {
      position: relative;
      padding: var(--topPad) 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      border-bottom:1px solid #e5e5e5;
      flex-wrap:wrap;
    }

    /* Logo top-right */
    #logo {
      position:absolute;
      top:8px;
      right:12px;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      color:#111;
    }
    #logo img {
      width:36px;
      height:36px;
      border-radius:8px;
    }

    #map {
      height: var(--mapH);
      min-height: 340px;
    }

    #panel {
      padding: var(--panelPad) 12px;
      border-top:1px solid #e5e5e5;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-start;
    }

    .box {
      border:1px solid #e5e5e5;
      padding:10px;
      border-radius:12px;
      background:#fafafa;
    }

    button {
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      white-space:nowrap;
    }

    input[type="number"] {
      padding:10px;
      width:86px;
      border-radius:12px;
      border:1px solid #ccc;
    }

    label { user-select:none; }

    pre {
      margin:0;
      white-space:pre-wrap;
      font-size:13px;
      line-height:1.35;
    }

    .small { font-size:12px; color:#444; margin-top:6px; }
    .btnrow button { margin-right:8px; margin-top:6px; }

    @media (max-width: 600px) {
      :root{
        --mapH: 36vh;
        --topPad: 8px;
        --panelPad: 8px;
      }
      #map { min-height: 220px; }
      #logo { top:6px; right:8px; }
    }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>

<body>
  <div id="top">
    <div id="logo">
      <img src="/static/icon-192.png" alt="RoofSpy">
      RoofSpy
    </div>

    <div class="box">
      <b>Draw</b><br/>
      <button id="btnDraw">Start</button>
      <button id="btnFinish">Finish</button>
      <button id="btnClear">Clear</button>
      <div class="small">Tap points → Finish</div>
    </div>

    <div class="box">
      <b>Parcels</b><br/>
      <label>Limit:</label>
      <input id="limit" type="number" value="80" min="10" max="2000"/>
      <button id="btnFetch">Fetch</button>
    </div>

    <div class="box">
      <b>Scan</b><br/>
      <label><input id="fastmode" type="checkbox" /> Fast</label>
      <label style="margin-left:10px;">Delay:</label>
      <input id="delay" type="number" value="1.2" min="0" step="0.1"/>
      <button id="btnStart">Start</button>
      <button id="btnStop">Stop</button>
      <div class="small">If errors spike: Delay 1.3–1.8</div>
    </div>
  </div>

  <div id="map"></div>

  <div id="panel">
    <div class="box" style="min-width: 320px; flex: 1;">
      <b>Status</b>
      <pre id="status">Ready.</pre>
      <div id="downloads" style="margin-top:8px;"></div>
      <div class="small">PDF opens inside the app.</div>
    </div>
  </div>

  <!-- PDF overlay (unchanged) -->
  <div id="pdfOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:9999;">
    <div style="position:absolute; inset:10px; background:#fff; border-radius:14px; overflow:hidden; display:flex; flex-direction:column;">
      <div style="padding:10px 12px; border-bottom:1px solid #e5e5e5; display:flex; justify-content:space-between; align-items:center;">
        <div id="pdfTitle" style="font-weight:700;">PDF</div>
        <button onclick="closePdf()">Close</button>
      </div>
      <iframe id="pdfFrame" style="flex:1; border:0;"></iframe>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/sw.js').catch(()=>{});
    }

    const KEY = new URLSearchParams(location.search).get("k") || "";
    const statusEl = document.getElementById("status");
    const downloadsEl = document.getElementById("downloads");
    let holdUntil = 0;

    function apiUrl(path){
      const u = new URL(path, location.origin);
      if(KEY) u.searchParams.set("k", KEY);
      return u.toString();
    }

    function setStatus(msg, holdMs=0){
      if(holdMs) holdUntil = Date.now()+holdMs;
      statusEl.textContent = msg;
    }

    const map = L.map("map").setView([26.7153,-80.0534],12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
    setTimeout(()=>map.invalidateSize(),400);

    let drawing=false, points=[], poly=null, temp=null, addresses=[];

    function clearAll(){
      drawing=false; points=[]; addresses=[];
      downloadsEl.innerHTML="";
      if(poly) map.removeLayer(poly), poly=null;
      if(temp) map.removeLayer(temp), temp=null;
      setStatus("Cleared.",1500);
    }

    function startDrawing(){ clearAll(); drawing=true; setStatus("Drawing…",2000); }

    function finishPolygon(){
      if(points.length<3) return alert("Need 3+ points");
      drawing=false;
      if(temp) map.removeLayer(temp);
      poly=L.polygon(points).addTo(map);
      setStatus("Polygon saved. Fetch parcels.",3000);
    }

    map.on("click",e=>{
      if(!drawing) return;
      points.push(e.latlng);
      if(temp) map.removeLayer(temp);
      temp=L.polyline(points,{dashArray:"6 6"}).addTo(map);
    });

    async function fetchParcels(){
      setStatus("Fetching parcels…",3000);
      const r=await fetch(apiUrl("/api/parcels"),{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({latlngs:points,limit:+limit.value})
      });
      const j=await r.json();
      addresses=j.addresses||[];
      setStatus(`Fetched ${addresses.length} addresses.`,3000);
    }

    async function startScan(){
      setStatus("Starting scan…",3000);
      await fetch(apiUrl("/api/start"),{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({addresses,delay:+delay.value,fast_mode:fastmode.checked})
      });
    }

    async function poll(){
      if(Date.now()<holdUntil) return;
      const r=await fetch(apiUrl("/api/status"));
      const s=await r.json();

      if(s.running){
        setStatus(`Running… ${s.done}/${s.total} | Good: ${s.good}`);
        downloadsEl.innerHTML="";
      }
      else if(s.message?.startsWith("Done")){
        setStatus(`Done. Number of good leads: ${s.good}`);
        downloadsEl.innerHTML=`
          <div class="btnrow">
            <button onclick="openPdf('ALL','/download/all.pdf')">View ALL (PDF)</button>
            <button onclick="openPdf('GOOD 20+','/download/good.pdf')">View GOOD 20+ (PDF)</button>
          </div>`;
      }
    }

    setInterval(poll,1500);

    function openPdf(title,path){
      pdfTitle.textContent=title;
      pdfFrame.src=apiUrl(path);
      pdfOverlay.style.display="block";
    }
    function closePdf(){
      pdfOverlay.style.display="none";
      pdfFrame.src="";
    }

    btnDraw.onclick=startDrawing;
    btnFinish.onclick=finishPolygon;
    btnClear.onclick=clearAll;
    btnFetch.onclick=fetchParcels;
    btnStart.onclick=startScan;
    btnStop.onclick=()=>fetch(apiUrl("/api/stop"),{method:"POST"});
  </script>
</body>
</html>
